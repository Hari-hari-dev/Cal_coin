<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solana Anchor DApp</title>
  <!-- Include Solana Web3.js (UMD version) -->
  <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.min.js"></script>
  <!-- Include the UMD build of Anchor (avoids module import errors) -->
  <script src="https://unpkg.com/@coral-xyz/anchor@0.31.0/dist/browser/index.js"></script>
  <script src="https://unpkg.com/@project-serum/anchor@0.27.0/dist/anchor.browser.umd.js" crossorigin></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    button, input { margin: 0.5em 0; }
    #status { margin-top: 1em; padding: 0.5em; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <!-- Wallet Connect Section -->
  <button id="connectButton">Connect Wallet (Phantom)</button>
  <p id="walletAddress" style="font-weight: bold;"></p>
  
  <!-- Set Exempt Section -->
  <h3>Set Exempt Address</h3>
  <p>
    <input type="text" id="exemptPubkeyInput" size="45" placeholder="Enter public key">
    <button id="setExemptButton" disabled>Set Exempt</button>
  </p>

  <!-- Register User Section -->
  <h3>Register User</h3>
  <p>
    <button id="registerButton" disabled>Register User</button>
  </p>

  <!-- Claim Tokens Section -->
  <h3>Claim Tokens</h3>
  <p>
    <button id="claimButton" disabled>Claim Rewards</button>
  </p>

  <!-- Status Message Area -->
  <div id="status"></div>

  <script>
    // Global variables for wallet, program, connection, etc.
    const statusEl = document.getElementById('status');
    const walletAddressEl = document.getElementById('walletAddress');
    const connectButton = document.getElementById('connectButton');
    const setExemptButton = document.getElementById('setExemptButton');
    const registerButton = document.getElementById('registerButton');
    const claimButton = document.getElementById('claimButton');
    let provider = null, program = null, connection = null, walletPublicKey = null;
    let dappConfigPda = null, mintAuthPda = null, tokenMintPubkey = null;

    // Replace the following with your full IDL JSON object.
    const idl = /* your full IDL JSON goes here */ {};

    // Program ID from your Anchor program declare_id!
    const programId = new anchor.web3.PublicKey("BYJtTQxe8F1Zi41bzWRStVPf57knpst3JqvZ7P5EMjex");

    // Connect wallet handler (Phantom should inject window.solana)
    connectButton.onclick = async () => {
      provider = window.solana;
      if (!provider || !provider.isPhantom) {
        statusEl.textContent = "Phantom wallet not found. Please install Phantom.";
        return;
      }
      try {
        await provider.connect();
        walletPublicKey = provider.publicKey;
        walletAddressEl.textContent = "Wallet Connected: " + walletPublicKey.toString();
        statusEl.textContent = "Wallet connected successfully.";
        console.log("Connected wallet:", walletPublicKey.toString());
        // Connect to Solana Devnet
        connection = new anchor.web3.Connection(anchor.web3.clusterApiUrl('devnet'), 'confirmed');
        const anchorProvider = new anchor.AnchorProvider(connection, provider, anchor.AnchorProvider.defaultOptions());
        anchor.setProvider(anchorProvider);
        // Initialize the Anchor program interface
        program = new anchor.Program(idl, programId, anchorProvider);
        console.log("Program initialized:", program.programId.toString());

        // Derive the dapp_config PDA (seed must match your program)
        [dappConfigPda] = await anchor.web3.PublicKey.findProgramAddress(
          [Buffer.from("dapp_config")],
          programId
        );
        console.log("dapp_config PDA:", dappConfigPda.toString());

        // Derive the mint_authority PDA (seed must match your program)
        [mintAuthPda] = await anchor.web3.PublicKey.findProgramAddress(
          [Buffer.from("mint_authority")],
          programId
        );
        console.log("mint_authority PDA:", mintAuthPda.toString());

        // Attempt to fetch tokenMint from the dapp_config account (if initialized)
        try {
          const configAccount = await program.account.dappConfig.fetch(dappConfigPda);
          tokenMintPubkey = configAccount.tokenMint;
          console.log("Token Mint:", tokenMintPubkey.toString());
        } catch (err) {
          console.warn("dapp_config account not found (token mint not available).");
        }
        // Enable buttons now that connection is set up
        setExemptButton.disabled = false;
        registerButton.disabled = false;
        claimButton.disabled = false;
      } catch (err) {
        console.error("Wallet connect error:", err);
        statusEl.textContent = "Error connecting wallet: " + (err.message || err);
      }
    };

    // Set Exempt handler
    setExemptButton.onclick = async () => {
      const input = document.getElementById('exemptPubkeyInput').value.trim();
      if (!input) {
        statusEl.textContent = "Enter a public key.";
        return;
      }
      let newExempt;
      try {
        newExempt = new anchor.web3.PublicKey(input);
      } catch (err) {
        statusEl.textContent = "Invalid public key.";
        return;
      }
      try {
        await program.methods
          .setExempt(newExempt)
          .accounts({
            dappConfig: dappConfigPda,
            currentExempt: walletPublicKey
          })
          .rpc();
        statusEl.textContent = "✅ set_exempt successful for " + newExempt.toString();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ set_exempt failed: " + (err.message || err);
      }
    };

    // Register User handler
    registerButton.onclick = async () => {
      if (!walletPublicKey) {
        statusEl.textContent = "Connect wallet first.";
        return;
      }
      // Derive the user PDA using seed "user" and the wallet's public key
      const [userPda] = await anchor.web3.PublicKey.findProgramAddress(
        [Buffer.from("user"), walletPublicKey.toBuffer()],
        programId
      );
      console.log("User PDA:", userPda.toString());
      if (!tokenMintPubkey) {
        statusEl.textContent = "Token mint not available from dapp_config.";
        return;
      }
      // Derive the user's Associated Token Account (ATA)
      const TOKEN_PROGRAM_ID = new anchor.web3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
      const ASSOCIATED_PROGRAM_ID = new anchor.web3.PublicKey("ATokenGPvbdGVtpfHhQZC2bH7m7QEupTQYxMtn6YDf");
      const [userAta] = await anchor.web3.PublicKey.findProgramAddress(
        [
          walletPublicKey.toBuffer(),
          TOKEN_PROGRAM_ID.toBuffer(),
          tokenMintPubkey.toBuffer()
        ],
        ASSOCIATED_PROGRAM_ID
      );
      console.log("User ATA:", userAta.toString());
      try {
        await program.methods
          .registerUser()
          .accounts({
            dappConfig: dappConfigPda,
            user: walletPublicKey,
            gatewayToken: walletPublicKey, // Using wallet as a placeholder for gateway token
            userPda: userPda,
            systemProgram: anchor.web3.SystemProgram.programId,
            rent: anchor.web3.SYSVAR_RENT_PUBKEY,
            tokenMint: tokenMintPubkey,
            mintAuthority: mintAuthPda,
            userAta: userAta,
            tokenProgram: TOKEN_PROGRAM_ID,
            associatedTokenProgram: ASSOCIATED_PROGRAM_ID
          })
          .rpc();
        statusEl.textContent = "✅ register_user successful, PDA: " + userPda.toString();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ register_user failed: " + (err.message || err);
      }
    };

    // Claim Tokens handler
    claimButton.onclick = async () => {
      if (!walletPublicKey) {
        statusEl.textContent = "Connect wallet first.";
        return;
      }
      const [userPda] = await anchor.web3.PublicKey.findProgramAddress(
        [Buffer.from("user"), walletPublicKey.toBuffer()],
        programId
      );
      const TOKEN_PROGRAM_ID = new anchor.web3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
      const ASSOCIATED_PROGRAM_ID = new anchor.web3.PublicKey("ATokenGPvbdGVtpfHhQZC2bH7m7QEupTQYxMtn6YDf");
      const [userAta] = await anchor.web3.PublicKey.findProgramAddress(
        [
          walletPublicKey.toBuffer(),
          TOKEN_PROGRAM_ID.toBuffer(),
          tokenMintPubkey.toBuffer()
        ],
        ASSOCIATED_PROGRAM_ID
      );
      try {
        await program.methods
          .claim()
          .accounts({
            dappConfig: dappConfigPda,
            user: walletPublicKey,
            gatewayToken: walletPublicKey, // placeholder for gateway token
            userPda: userPda,
            tokenMint: tokenMintPubkey,
            mintAuthority: mintAuthPda,
            userAta: userAta,
            tokenProgram: TOKEN_PROGRAM_ID
          })
          .rpc();
        statusEl.textContent = "✅ claim successful.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ claim failed: " + (err.message || err);
      }
    };
  </script>
</body>
</html>
