<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solana Anchor DApp</title>
  <!-- Load Solana Web3.js UMD bundle -->
  <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.min.js" crossorigin="anonymous"></script>
  <!-- Load Anchor UMD bundle from @project-serum/anchor v0.25.0 -->
  <script src="https://cdn.jsdelivr.net/npm/@project-serum/anchor@0.25.0/dist/anchor.browser.umd.js" crossorigin="anonymous"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    button, input { margin: 0.5em 0; }
    #status { margin-top: 1em; padding: 0.5em; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <!-- Wallet Connection Section -->
  <button id="connectButton">Connect Wallet (Phantom)</button>
  <p id="walletAddress" style="font-weight:bold;"></p>

  <!-- Set Exempt Address Section -->
  <h3>Set Exempt Address</h3>
  <p>
    <input type="text" id="exemptPubkeyInput" size="45" placeholder="Enter new exempt public key">
    <button id="setExemptButton" disabled>Set Exempt</button>
  </p>

  <!-- Register User Section -->
  <h3>Register User</h3>
  <p>
    <button id="registerButton" disabled>Register User</button>
  </p>

  <!-- Claim Tokens Section -->
  <h3>Claim Tokens</h3>
  <p>
    <button id="claimButton" disabled>Claim Rewards</button>
  </p>

  <!-- Status Message Area -->
  <div id="status"></div>

  <script>
    // Global DOM elements
    const statusEl = document.getElementById('status');
    const walletAddressEl = document.getElementById('walletAddress');
    const connectButton = document.getElementById('connectButton');
    const setExemptButton = document.getElementById('setExemptButton');
    const registerButton = document.getElementById('registerButton');
    const claimButton = document.getElementById('claimButton');
    
    // Global variables for wallet, connection, and program
    let provider, walletPublicKey, connection, program;
    let dappConfigPda, mintAuthPda, tokenMintPubkey;
    
    // Replace this placeholder with your full IDL JSON object
    const idl = {
      /* Paste your full IDL JSON here */
    };
    
    // Your program ID from your on‑chain Anchor program
    const programId = new anchor.web3.PublicKey("BYJtTQxe8F1Zi41bzWRStVPf57knpst3JqvZ7P5EMjex");
    
    // Connect Phantom wallet button handler
    connectButton.onclick = async () => {
      provider = window.solana;
      if (!provider || !provider.isPhantom) {
        statusEl.textContent = "Phantom wallet not found. Please install Phantom.";
        return;
      }
      try {
        await provider.connect();
        walletPublicKey = provider.publicKey;
        walletAddressEl.textContent = "Wallet Connected: " + walletPublicKey.toString();
        statusEl.textContent = "Wallet connected successfully.";
        console.log("Connected wallet:", walletPublicKey.toString());
  
        // Connect to Solana Devnet
        connection = new anchor.web3.Connection(anchor.web3.clusterApiUrl('devnet'), 'confirmed');
        const anchorProvider = new anchor.AnchorProvider(connection, provider, anchor.AnchorProvider.defaultOptions());
        anchor.setProvider(anchorProvider);
  
        // Initialize the Anchor program interface
        program = new anchor.Program(idl, programId, anchorProvider);
        console.log("Program initialized:", program.programId.toString());
  
        // Derive the dapp_config PDA (seed must match your on‑chain program)
        [dappConfigPda] = await anchor.web3.PublicKey.findProgramAddress(
          [Buffer.from("dapp_config")],
          programId
        );
        console.log("dapp_config PDA:", dappConfigPda.toString());
  
        // Derive the mint_authority PDA (seed must match your on‑chain program)
        [mintAuthPda] = await anchor.web3.PublicKey.findProgramAddress(
          [Buffer.from("mint_authority")],
          programId
        );
        console.log("mint_authority PDA:", mintAuthPda.toString());
  
        // Optionally, fetch the dapp_config account to get tokenMint (if initialized)
        try {
          const configAccount = await program.account.dappConfig.fetch(dappConfigPda);
          tokenMintPubkey = configAccount.tokenMint;
          console.log("Token mint fetched:", tokenMintPubkey.toString());
        } catch (err) {
          console.warn("dapp_config account not found; token mint unavailable.");
        }
  
        // Enable action buttons now that connection is established
        setExemptButton.disabled = false;
        registerButton.disabled = false;
        claimButton.disabled = false;
      } catch (err) {
        console.error("Wallet connection error:", err);
        statusEl.textContent = "Error connecting wallet: " + err.message;
      }
    };
    
    // Handler for Set Exempt instruction
    setExemptButton.onclick = async () => {
      const input = document.getElementById('exemptPubkeyInput').value.trim();
      if (!input) {
        statusEl.textContent = "Please enter a public key.";
        return;
      }
      let newExempt;
      try {
        newExempt = new anchor.web3.PublicKey(input);
      } catch (err) {
        statusEl.textContent = "Invalid public key.";
        return;
      }
      try {
        await program.methods.setExempt(newExempt)
          .accounts({
            dappConfig: dappConfigPda,
            currentExempt: walletPublicKey
          })
          .rpc();
        statusEl.textContent = "✅ set_exempt executed for " + newExempt.toString();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ set_exempt error: " + err.message;
      }
    };
    
    // Handler for Register User instruction
    registerButton.onclick = async () => {
      if (!walletPublicKey) {
        statusEl.textContent = "Connect wallet first.";
        return;
      }
      // Derive the user's PDA using seed ["user", userPubkey]
      const [userPda] = await anchor.web3.PublicKey.findProgramAddress(
        [Buffer.from("user"), walletPublicKey.toBuffer()],
        programId
      );
      console.log("User PDA:", userPda.toString());
      if (!tokenMintPubkey) {
        statusEl.textContent = "Token mint not available from dapp_config.";
        return;
      }
      // Derive the user's associated token account (ATA)
      const TOKEN_PROGRAM_ID = new anchor.web3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
      const ASSOCIATED_PROGRAM_ID = new anchor.web3.PublicKey("ATokenGPvbdGVtpfHhQZC2bH7m7QEupTQYxMtn6YDf");
      const [userAta] = await anchor.web3.PublicKey.findProgramAddress(
        [
          walletPublicKey.toBuffer(),
          TOKEN_PROGRAM_ID.toBuffer(),
          tokenMintPubkey.toBuffer()
        ],
        ASSOCIATED_PROGRAM_ID
      );
      console.log("User ATA:", userAta.toString());
      try {
        await program.methods.registerUser()
          .accounts({
            dappConfig: dappConfigPda,
            user: walletPublicKey,
            gatewayToken: walletPublicKey, // Placeholder for gateway token if needed
            userPda: userPda,
            systemProgram: anchor.web3.SystemProgram.programId,
            rent: anchor.web3.SYSVAR_RENT_PUBKEY,
            tokenMint: tokenMintPubkey,
            mintAuthority: mintAuthPda,
            userAta: userAta,
            tokenProgram: TOKEN_PROGRAM_ID,
            associatedTokenProgram: ASSOCIATED_PROGRAM_ID
          })
          .rpc();
        statusEl.textContent = "✅ register_user executed. PDA: " + userPda.toString();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ register_user error: " + err.message;
      }
    };
    
    // Handler for Claim instruction
    claimButton.onclick = async () => {
      if (!walletPublicKey) {
        statusEl.textContent = "Connect wallet first.";
        return;
      }
      const [userPda] = await anchor.web3.PublicKey.findProgramAddress(
        [Buffer.from("user"), walletPublicKey.toBuffer()],
        programId
      );
      const TOKEN_PROGRAM_ID = new anchor.web3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
      const ASSOCIATED_PROGRAM_ID = new anchor.web3.PublicKey("ATokenGPvbdGVtpfHhQZC2bH7m7QEupTQYxMtn6YDf");
      const [userAta] = await anchor.web3.PublicKey.findProgramAddress(
        [
          walletPublicKey.toBuffer(),
          TOKEN_PROGRAM_ID.toBuffer(),
          tokenMintPubkey.toBuffer()
        ],
        ASSOCIATED_PROGRAM_ID
      );
      try {
        await program.methods.claim()
          .accounts({
            dappConfig: dappConfigPda,
            user: walletPublicKey,
            gatewayToken: walletPublicKey, // Placeholder for gateway token if needed
            userPda: userPda,
            tokenMint: tokenMintPubkey,
            mintAuthority: mintAuthPda,
            userAta: userAta,
            tokenProgram: TOKEN_PROGRAM_ID
          })
          .rpc();
        statusEl.textContent = "✅ claim executed successfully.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ claim error: " + err.message;
      }
    };
  </script>
</body>
</html>
