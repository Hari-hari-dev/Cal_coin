<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solana dApp – Minimal Initialize Dapp Example</title>
  <!-- Include Solana web3.js via CDN -->
  <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    button { margin: 0.5em 0; padding: 0.5em 1em; }
    input { margin: 0.5em 0; padding: 0.4em; }
  </style>
</head>
<body>
  <h1>Solana dApp – Initialize Dapp (Real)</h1>
  
  <button id="connect">Connect Phantom</button>
  <p id="output">Not connected</p>
  
  <hr>
  
  <h2>Initialize Dapp</h2>
  <input type="number" id="initAmount" placeholder="Initial Mint Amount (μtokens)" />
  <button id="initDapp" disabled>Initialize Dapp</button>
  <p id="initOutput">Dapp not initialized.</p>
  
  <script>
    // Your actual deployed Program ID
    const PROGRAM_ID = new solanaWeb3.PublicKey("BYJtTQxe8F1Zi41bzWRStVPf57knpst3JqvZ7P5EMjex");

    // Your actual Token Mint address (pre-created token mint)
    const TOKEN_MINT = new solanaWeb3.PublicKey("Replace_with_your_actual_Token_Mint_address_here");

    const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb");
    const ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("ATokenGPvbhRt7Z8BUGKh9dn1dPnse5xCCom1ULxq");

    const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("devnet"), "confirmed");

    let wallet;

    const btn = document.getElementById("connect");
    const output = document.getElementById("output");
    const initBtn = document.getElementById("initDapp");
    const initOutput = document.getElementById("initOutput");

    btn.onclick = async () => {
      try {
        await window.solana.connect();
        wallet = window.solana;
        output.textContent = `Connected: ${wallet.publicKey.toString()}`;
        initBtn.disabled = false;
      } catch (err) {
        output.textContent = `Error: ${err.message}`;
      }
    };

    // Computes PDA (Program Derived Address)
    const getPDA = (seeds, programId) => 
      solanaWeb3.PublicKey.findProgramAddressSync(seeds, programId);

    // Helper to derive ATA (associated token account)
    const findAssociatedTokenAddress = (walletAddress, tokenMintAddress) => {
      return solanaWeb3.PublicKey.findProgramAddressSync(
        [
          walletAddress.toBuffer(),
          TOKEN_PROGRAM_ID.toBuffer(),
          tokenMintAddress.toBuffer(),
        ],
        ASSOCIATED_TOKEN_PROGRAM_ID
      )[0];
    };

    // discriminator: first 8 bytes of sha256("global:initialize_dapp")
    const DISCRIMINATOR_INIT = Uint8Array.from([0x7f,0x66,0x9d,0xda,0x92,0xf1,0xe6,0x00]);

    // converts number to u64 little endian byte array
    const u64ToLeBytes = (num) => {
      const buffer = new ArrayBuffer(8);
      new DataView(buffer).setBigUint64(0, BigInt(num), true);
      return new Uint8Array(buffer);
    };

    initBtn.onclick = async () => {
      try {
        const initAmount = Number(document.getElementById("initAmount").value);
        if (!initAmount || initAmount <= 0) throw new Error("Enter a valid mint amount.");

        const [dappConfigPda] = getPDA([Buffer.from("dapp_config")], PROGRAM_ID);
        const [mintAuthorityPda] = getPDA([Buffer.from("mint_authority")], PROGRAM_ID);
        const userAta = findAssociatedTokenAddress(wallet.publicKey, TOKEN_MINT);

        const instructionData = new Uint8Array(16);
        instructionData.set(DISCRIMINATOR_INIT, 0);
        instructionData.set(u64ToLeBytes(initAmount), 8);

        const keys = [
          { pubkey: dappConfigPda, isSigner: false, isWritable: true },
          { pubkey: wallet.publicKey, isSigner: true, isWritable: true },
          { pubkey: TOKEN_MINT, isSigner: false, isWritable: false },
          { pubkey: mintAuthorityPda, isSigner: false, isWritable: true },
          { pubkey: userAta, isSigner: false, isWritable: true },
          { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false },
          { pubkey: solanaWeb3.SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false },
          { pubkey: ASSOCIATED_TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
          { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
        ];

        const tx = new solanaWeb3.Transaction().add(
          new solanaWeb3.TransactionInstruction({
            programId: PROGRAM_ID,
            keys,
            data: instructionData,
          })
        );

        tx.feePayer = wallet.publicKey;
        tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

        const { signature } = await wallet.signAndSendTransaction(tx);
        await connection.confirmTransaction(signature);

        initOutput.textContent = `Success: ${signature}`;
      } catch (err) {
        console.error(err);
        initOutput.textContent = `Error: ${err.message}`;
      }
    };
  </script>
</body>
</html>
