<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solana dApp – Initialize Dapp and Mint</title>

  <script src="https://unpkg.com/buffer-polyfill@6.0.3/dist/buffer.umd.cjs"></script>

  <!-- 2. Make Buffer globally available for libraries -->
  <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    button { margin: 0.5em 0; padding: 0.5em 1em; }
    input { margin: 0.5em 0; padding: 0.4em; }
  </style>
</head>
<body>
  <h1>Initialize Dapp and Mint</h1>

  <!-- Wallet Connection -->
  <button id="connect">Connect Phantom</button>
  <p id="output">Not connected</p>

  <hr>

  <!-- Initialize Dapp and Mint -->
  <h2>Initialize Dapp</h2>
  <input type="number" id="initAmount" placeholder="Initial Mint Amount (in μtokens)" />
  <button id="initDapp" disabled>Initialize Dapp and Mint</button>
  <p id="initOutput">Dapp not initialized.</p>

  <script>
    const PROGRAM_ID = new solanaWeb3.PublicKey("Ut7RHuZp1PKQ581aa2TpJ39UYgs6vBna6v67RvpS9Ys");
    const discriminator_init = Uint8Array.from([0xeb,0x1e,0xb3,0x94,0xb9,0xa8,0x7d,0x4b]);
    //const TOKEN_MINT = new solanaWeb3.PublicKey("YourTokenMintAddressHere");
    const TOKEN_2022_PROGRAM_ID = new solanaWeb3.PublicKey("TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb");
    const ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL");
      
        // Discriminator arrays computed from Anchor:
    const DISCRIMINATOR_SET_EXEMPT = new Uint8Array([0xf4, 0x49, 0x57, 0xbe, 0xa2, 0x7c, 0x96, 0x18]);
    const DISCRIMINATOR_REGISTER_USER = new Uint8Array([0x02, 0xf1, 0x96, 0xdf, 0x63, 0xd6, 0x74, 0x61]);
    const DISCRIMINATOR_CLAIM = new Uint8Array([0x3e, 0xc6, 0xd6, 0xc1, 0xd5, 0x9f, 0x6c, 0xd2]);
      
    const btn = document.getElementById("connect");
    const output = document.getElementById("output");
    const initBtn = document.getElementById("initDapp");
    const initOutput = document.getElementById("initOutput");

    let wallet, connection;

    btn.onclick = async () => {
      try {
        wallet = window.solana;
        await wallet.connect({ onlyIfTrusted: false });
        connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'));
        output.textContent = `Connected: ${wallet.publicKey}`;
        initBtn.disabled = false;
      } catch (err) {
        output.textContent = `Error: ${err.message}`;
      }
    };

    initBtn.onclick = async () => {
      try {
        const initialMintAmount = BigInt(document.getElementById("initAmount").value);
        if (initialMintAmount <= 0n) throw new Error("Invalid mint amount");

        const mintKeypair = solanaWeb3.Keypair.generate();

        const [dappConfigPda] = solanaWeb3.PublicKey.findProgramAddressSync(
          [Buffer.from("dapp"), mintKeypair.publicKey.toBytes()], PROGRAM_ID
        );

        const [mintAuthorityPda] = solanaWeb3.PublicKey.findProgramAddressSync(
          [Buffer.from("mint_authority")], PROGRAM_ID
        );

        const ata = await solanaWeb3.PublicKey.findProgramAddressSync(
          [wallet.publicKey.toBuffer(), TOKEN_2022_PROGRAM_ID.toBuffer(), mintKeypair.publicKey.toBuffer()],
          new solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL')
        );

        const initAmountBuffer = new ArrayBuffer(8);
        new DataView(initAmountBuffer).setBigUint64(0, initialMintAmount, true);

        const data = Buffer.concat([
          discriminator_init,
          Buffer.from(initAmountBuffer)
        ]);

        const tx = new solanaWeb3.Transaction().add(
          new solanaWeb3.TransactionInstruction({
            programId: PROGRAM_ID,
            keys: [
              {pubkey: dappConfigPda, isSigner: false, isWritable: true},
              {pubkey: mintAuthorityPda, isSigner: false, isWritable: true},
              {pubkey: mintKeypair.publicKey, isSigner: false, isWritable: true},
              {pubkey: wallet.publicKey, isSigner: true, isWritable: true},
              {pubkey: ata[0], isSigner: false, isWritable: true},
              {pubkey: new solanaWeb3.PublicKey('TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb'), isSigner: false, isWritable: false},
              {pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false},
              {pubkey: solanaWeb3.SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false},
              {pubkey: new solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL'), isSigner: false, isWritable: false},
            ],
            data: data
          })
        );

        tx.feePayer = wallet.publicKey;
        tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
        tx.partialSign(mintKeypair);

        const signedTx = await wallet.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signedTx.serialize());

        initOutput.textContent = `Transaction sent: ${sig}`;
      } catch (err) {
        console.error(err);
        initOutput.textContent = `Error initializing dapp: ${err.message}`;
      }
    };
  </script>
</body>
</html>
