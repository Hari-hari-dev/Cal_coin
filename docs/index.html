<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solana DApp</title>

  <!-- Corrected Buffer Polyfill -->
  <script src="https://cdn.jsdelivr.net/npm/buffer-polyfill@6.0.3/dist/buffer.umd.cjs"></script>
  <script>
    window.Buffer = buffer.Buffer;
  </script>

  <!-- Load Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.min.js"></script>

  <!-- Load the UMD bundle -->
  <script src="./bundle.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 5px; padding: 10px; }
    input { margin: 5px; padding: 10px; width: 300px; }
    #status { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Solana DApp</h1>

  <!-- Wallet Connection -->
  <button id="connectWallet">Connect Wallet</button>
  <div id="walletAddress"></div>

  <!-- Set Exempt Address -->
  <h3>Set Exempt Address</h3>
  <input type="text" id="exemptAddress" placeholder="Enter Public Key">
  <button id="setExempt" disabled>Set Exempt</button>

  <!-- Register User -->
  <h3>Register User</h3>
  <button id="registerUser" disabled>Register User</button>

  <!-- Claim Tokens -->
  <h3>Claim Tokens</h3>
  <button id="claimTokens" disabled>Claim Tokens</button>

  <!-- Status Display -->
  <div id="status"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const connectWalletButton = document.getElementById('connectWallet');
      const setExemptButton = document.getElementById('setExempt');
      const registerUserButton = document.getElementById('registerUser');
      const claimTokensButton = document.getElementById('claimTokens');
      const walletAddressDiv = document.getElementById('walletAddress');
      const statusDiv = document.getElementById('status');

      let provider = null;
      let program = null;

      // Load IDL
      const idl = await fetch('./idl.json').then(res => res.json());

      // Solana program ID
      const programId = new solanaWeb3.PublicKey('BYJtTQxe8F1Zi41bzWRStVPf57knpst3JqvZ7P5EMjex');

      // Connect to Phantom Wallet
      connectWalletButton.onclick = async () => {
        if (window.solana && window.solana.isPhantom) {
          try {
            await window.solana.connect();
            provider = window.solana;
            walletAddressDiv.textContent = `Connected: ${provider.publicKey.toString()}`;
            statusDiv.textContent = 'Wallet connected successfully.';

            // Initialize Anchor provider and program
            const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('devnet'), 'confirmed');
            const anchorProvider = new anchor.AnchorProvider(connection, provider, anchor.AnchorProvider.defaultOptions());
            anchor.setProvider(anchorProvider);
            program = new anchor.Program(idl, programId, anchorProvider);

            // Enable buttons after connection
            setExemptButton.disabled = false;
            registerUserButton.disabled = false;
            claimTokensButton.disabled = false;
          } catch (err) {
            statusDiv.textContent = `Error connecting wallet: ${err.message}`;
          }
        } else {
          statusDiv.textContent = 'Phantom wallet not found. Please install it.';
        }
      };

      // Set Exempt Address
      setExemptButton.onclick = async () => {
        const exemptAddressInput = document.getElementById('exemptAddress').value.trim();
        if (!exemptAddressInput) {
          statusDiv.textContent = 'Please enter a public key.';
          return;
        }
        try {
          const newExempt = new solanaWeb3.PublicKey(exemptAddressInput);
          const [dappConfigPda] = await solanaWeb3.PublicKey.findProgramAddress(
            [Buffer.from('dapp_config')],
            programId
          );
          await program.methods.setExempt(newExempt)
            .accounts({
              dappConfig: dappConfigPda,
              currentExempt: provider.publicKey
            })
            .rpc();
          statusDiv.textContent = `Exempt address set to: ${newExempt.toString()}`;
        } catch (err) {
          statusDiv.textContent = `Error setting exempt address: ${err.message}`;
        }
      };

      // Register User
      registerUserButton.onclick = async () => {
        try {
          const [userPda] = await solanaWeb3.PublicKey.findProgramAddress(
            [Buffer.from('user'), provider.publicKey.toBuffer()],
            programId
          );
          await program.methods.registerUser()
            .accounts({
              user: provider.publicKey,
              userPda,
              systemProgram: solanaWeb3.SystemProgram.programId
            })
            .rpc();
          statusDiv.textContent = 'User registered successfully.';
        } catch (err) {
          statusDiv.textContent = `Error registering user: ${err.message}`;
        }
      };

      // Claim Tokens
      claimTokensButton.onclick = async () => {
        try {
          const [userPda] = await solanaWeb3.PublicKey.findProgramAddress(
            [Buffer.from('user'), provider.publicKey.toBuffer()],
            programId
          );
          await program.methods.claim()
            .accounts({
              user: provider.publicKey,
              userPda,
              systemProgram: solanaWeb3.SystemProgram.programId
            })
            .rpc();
          statusDiv.textContent = 'Tokens claimed successfully.';
        } catch (err) {
          statusDiv.textContent = `Error claiming tokens: ${err.message}`;
        }
      };
    });
  </script>
</body>
</html>
